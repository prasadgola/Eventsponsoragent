<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Live Audio & Video</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #212121;
            color: #e8eaed;
            height: 100vh;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        /* Header - overlay on top of video */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: rgba(33, 33, 33, 0.7);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: #8ab4f8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: #202124;
        }

        .header-info h1 {
            color: #e8eaed;
            font-size: 1.25rem;
            font-weight: 500;
            margin: 0;
            display: flex;
            gap: 2px;
            cursor: pointer;
        }

        /* Jelly Wiggle Animation */
        .jelly-logo span {
            display: inline-block;
            animation: jelly 2.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) infinite;
        }

        .jelly-logo span:nth-child(1) { animation-delay: 0s; }
        .jelly-logo span:nth-child(2) { animation-delay: 0.1s; }
        .jelly-logo span:nth-child(3) { animation-delay: 0.2s; }
        .jelly-logo span:nth-child(4) { animation-delay: 0.3s; }
        .jelly-logo span:nth-child(5) { animation-delay: 0.4s; }
        .jelly-logo span:nth-child(6) { animation-delay: 0.5s; }

        @keyframes jelly {
            0%, 100% {
                transform: scale(1, 1) rotate(0deg);
            }
            20% {
                transform: scale(1.1, 0.9) rotate(-2deg);
            }
            40% {
                transform: scale(0.9, 1.1) rotate(2deg);
            }
            60% {
                transform: scale(1.05, 0.95) rotate(-1deg);
            }
            80% {
                transform: scale(0.95, 1.05) rotate(1deg);
            }
        }

        .theme-toggle {
            background: rgba(60, 64, 67, 0.8);
            color: #e8eaed;
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            background: rgba(60, 64, 67, 1);
            color: #ffffff;
        }

        /* Light theme */
        body.light-theme {
            background: #ffffff;
            color: #202124;
        }

        .light-theme .header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .light-theme .logo {
            background: #1a73e8;
            color: #ffffff;
        }

        .light-theme .header-info h1 {
            color: #202124;
        }

        .light-theme .theme-toggle {
            background: rgba(241, 243, 244, 0.8);
            color: #202124;
        }

        .light-theme .theme-toggle:hover {
            background: rgba(241, 243, 244, 1);
            color: #000000;
        }

        /* Audio Visualization - Glowing Orb */
        .audio-visualizer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .audio-visualizer.hidden {
            display: none;
        }

        .orb-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .orb {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #8ab4f8, #1a73e8);
            border-radius: 50%;
            transition: all 0.1s ease-out;
            box-shadow: 0 0 40px rgba(138, 180, 248, 0.6);
        }

        .light-theme .orb {
            background: radial-gradient(circle at center, #1a73e8, #1557b0);
            box-shadow: 0 0 40px rgba(26, 115, 232, 0.6);
        }

        /* Video container - full screen */
        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: #000;
            z-index: 1;
        }

        .video-container.active {
            display: flex;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Control buttons - overlay on top of video */
        .control-buttons {
            position: fixed;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-btn {
            border: none;
            padding: 0.625rem;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            background: rgba(60, 64, 67, 0.8);
            backdrop-filter: blur(10px);
            color: #e8eaed;
        }

        .control-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }

        .control-btn:hover {
            background: rgba(60, 64, 67, 1);
            color: #ffffff;
        }

        .control-btn.active {
            background: rgba(138, 180, 248, 0.9);
            color: #202124;
        }

        .stop-btn {
            background: rgba(242, 139, 130, 0.8);
            color: #ffffff;
        }

        .stop-btn:hover {
            background: rgba(242, 139, 130, 1);
            color: #ffffff;
        }

        .light-theme .control-btn {
            background: rgba(241, 243, 244, 0.8);
            color: #202124;
        }

        .light-theme .control-btn:hover {
            background: rgba(241, 243, 244, 1);
            color: #000000;
        }

        .light-theme .control-btn.active {
            background: rgba(26, 115, 232, 0.9);
            color: #ffffff;
        }

        .light-theme .stop-btn {
            background: rgba(217, 48, 37, 0.8);
            color: #ffffff;
        }

        .light-theme .stop-btn:hover {
            background: rgba(217, 48, 37, 1);
            color: #ffffff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .control-buttons {
                bottom: 2rem;
            }

            .orb-container {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">ES</div>
            <div class="header-info">
                <h1 class="jelly-logo" onclick="location.href='index.html'">
                    <span>E</span><span>v</span><span>e</span><span>n</span><span>t</span><span>s</span>
                </h1>
            </div>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
        </button>
    </div>

    <!-- Audio Visualizer -->
    <div class="audio-visualizer" id="audioVisualizer">
        <div class="orb-container">
            <div class="orb" id="orb"></div>
        </div>
    </div>

    <div class="video-container" id="videoContainer">
        <video id="videoElement" autoplay muted playsinline></video>
    </div>

    <div class="control-buttons">
        <button class="control-btn video-btn" id="videoBtn" title="Toggle video">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg>
        </button>
        <button class="control-btn screen-btn" id="screenBtn" title="Share screen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
        </button>
        <button class="control-btn stop-btn" id="stopBtn" title="Stop live conversation">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            PROD_ADK_SERVER_URL: 'https://adk-backend-service-766291037876.us-central1.run.app',
            LOCAL_ADK_SERVER_URL: 'http://localhost:8000',
            APP_NAME: 'chat_with_human'
        };

        const isLocal = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' ||
                       window.location.hostname === '' ||
                       window.location.port === '8080';

        const ADK_SERVER_URL = isLocal ? CONFIG.LOCAL_ADK_SERVER_URL : CONFIG.PROD_ADK_SERVER_URL;
        const APP_NAME = CONFIG.APP_NAME;
        const USER_ID = 'demo_user';
        const SESSION_ID = 'default_session';

        console.log('🌐 Environment Detection:');
        console.log('  - Is Local:', isLocal);
        console.log('  - ADK Server:', ADK_SERVER_URL);

        // State
        let socket = null;
        let mediaRecorder = null;
        let audioContext = null;
        let audioQueue = [];
        let isPlaying = false;
        let isStreaming = false;
        let videoStream = null;
        let screenStream = null;
        let videoEnabled = false;
        let screenEnabled = false;
        let videoFrameInterval = null;

        // Audio visualization state
        let analyserNode = null;
        let dataArray = null;
        let animationFrameId = null;
        const orb = document.getElementById('orb');

        // Theme functions
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLightTheme = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLightTheme ? 'light' : 'dark');
            updateThemeIcon(isLightTheme);
        }

        function updateThemeIcon(isLightTheme) {
            const icon = document.getElementById('themeToggle').querySelector('svg');
            if (isLightTheme) {
                icon.innerHTML = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`;
            } else {
                icon.innerHTML = `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const shouldUseLightTheme = savedTheme === 'light' || (savedTheme === null && !prefersDark);
            if (shouldUseLightTheme) {
                document.body.classList.add('light-theme');
            }
            updateThemeIcon(shouldUseLightTheme);
        }

        // Audio Visualization Functions
        function setupAudioVisualization() {
            if (!audioContext || !analyserNode) return;

            const bufferLength = analyserNode.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            function animate() {
                animationFrameId = requestAnimationFrame(animate);

                analyserNode.getByteFrequencyData(dataArray);

                // Calculate average frequency
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;

                // Normalize to 0-1 range
                const normalized = average / 255;

                // Calculate scale and glow based on audio level
                const scale = 1 + (normalized * 0.5); // Scale from 1 to 1.5
                const glowIntensity = 40 + (normalized * 60); // Glow from 40px to 100px
                const opacity = 0.6 + (normalized * 0.3); // Opacity from 0.6 to 0.9

                // Apply transformations
                orb.style.transform = `scale(${scale})`;
                orb.style.boxShadow = `0 0 ${glowIntensity}px rgba(138, 180, 248, ${opacity})`;
            }

            animate();
        }

        function stopAudioVisualization() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            // Reset orb to default state
            orb.style.transform = 'scale(1)';
            orb.style.boxShadow = '0 0 40px rgba(138, 180, 248, 0.6)';
        }

        // Session management
        async function ensureSession() {
            const sessionUrl = `${ADK_SERVER_URL}/apps/${APP_NAME}/users/${USER_ID}/sessions/${SESSION_ID}`;

            try {
                const response = await fetch(sessionUrl);
                if (response.ok) return true;
            } catch (e) { }

            try {
                const response = await fetch(sessionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ state: {} })
                });

                if (response.ok || response.status === 409) return true;
                throw new Error(`Session creation failed: ${response.status}`);
            } catch (error) {
                console.error('❌ Session error:', error);
                return false;
            }
        }

        // Video functions
        async function toggleVideo() {
            if (!videoEnabled) {
                await startVideo();
            } else {
                stopVideo();
            }
        }

        async function startVideo() {
            console.log('📹 Starting video...');
            
            // Stop screen share if active
            if (screenEnabled) {
                stopScreen();
            }
            
            // Hide audio visualizer
            document.getElementById('audioVisualizer').classList.add('hidden');
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }
                });

                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = videoStream;
                
                document.getElementById('videoContainer').classList.add('active');
                document.getElementById('videoBtn').classList.add('active');
                
                videoEnabled = true;
                startVideoStreaming();
                
                console.log('✅ Video started successfully');
            } catch (error) {
                console.error('❌ Error starting video:', error);
                alert(`Failed to start video: ${error.message}`);
                // Show visualizer again if video failed
                document.getElementById('audioVisualizer').classList.remove('hidden');
            }
        }

        function stopVideo() {
            console.log('🛑 Stopping video...');
            
            if (videoFrameInterval) {
                clearInterval(videoFrameInterval);
                videoFrameInterval = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            const videoElement = document.getElementById('videoElement');
            videoElement.srcObject = null;
            
            document.getElementById('videoContainer').classList.remove('active');
            document.getElementById('videoBtn').classList.remove('active');
            
            // Show audio visualizer again
            document.getElementById('audioVisualizer').classList.remove('hidden');
            
            videoEnabled = false;
            console.log('✅ Video stopped');
        }

        // Screen share functions
        async function toggleScreen() {
            if (!screenEnabled) {
                await startScreen();
            } else {
                stopScreen();
            }
        }

        async function startScreen() {
            console.log('🖥️ Starting screen share...');
            
            // Stop camera video if active
            if (videoEnabled) {
                stopVideo();
            }
            
            // Hide audio visualizer
            document.getElementById('audioVisualizer').classList.add('hidden');
            
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    }
                });

                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = screenStream;
                
                document.getElementById('videoContainer').classList.add('active');
                document.getElementById('screenBtn').classList.add('active');
                
                screenEnabled = true;
                startVideoStreaming();
                
                // Handle when user stops sharing via browser UI
                screenStream.getVideoTracks()[0].onended = () => {
                    stopScreen();
                };
                
                console.log('✅ Screen share started successfully');
            } catch (error) {
                console.error('❌ Error starting screen share:', error);
                if (error.name !== 'NotAllowedError') {
                    alert(`Failed to start screen share: ${error.message}`);
                }
                // Show visualizer again if screen share failed
                document.getElementById('audioVisualizer').classList.remove('hidden');
            }
        }

        function stopScreen() {
            console.log('🛑 Stopping screen share...');
            
            if (videoFrameInterval) {
                clearInterval(videoFrameInterval);
                videoFrameInterval = null;
            }
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            const videoElement = document.getElementById('videoElement');
            videoElement.srcObject = null;
            
            document.getElementById('videoContainer').classList.remove('active');
            document.getElementById('screenBtn').classList.remove('active');
            
            // Show audio visualizer again
            document.getElementById('audioVisualizer').classList.remove('hidden');
            
            screenEnabled = false;
            console.log('✅ Screen share stopped');
        }

        function startVideoStreaming() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const videoElement = document.getElementById('videoElement');
            
            // Send frames at 1 FPS (adjust as needed)
            videoFrameInterval = setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN && (videoEnabled || screenEnabled)) {
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob((blob) => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64data = reader.result.split(',')[1];
                            
                            const videoMessage = {
                                "blob": {
                                    "mime_type": "image/jpeg",
                                    "data": base64data
                                }
                            };
                            
                            socket.send(JSON.stringify(videoMessage));
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', 0.8);
                }
            }, 1000); // 1 frame per second
        }

        // Live audio functions
        async function startLiveSession() {
            console.log('🎙️ Starting live session...');

            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 24000
                    });
                }

                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                await connectLiveWebSocket(stream);
                isStreaming = true;

            } catch (error) {
                console.error('❌ Error starting live session:', error);
                alert(`Failed to start live session: ${error.message}`);
                stopLiveSession();
            }
        }

        function stopLiveSession() {
            console.log('🛑 Stopping live session...');

            stopVideo();
            stopScreen();
            stopAudioVisualization();

            if (mediaRecorder) {
                if (mediaRecorder.processor) {
                    mediaRecorder.processor.disconnect();
                    mediaRecorder.source.disconnect();
                }
                mediaRecorder = null;
            }

            if (socket) {
                socket.close();
                socket = null;
            }

            audioQueue = [];
            isPlaying = false;
            isStreaming = false;

            window.location.href = 'index.html';
        }

        async function connectLiveWebSocket(stream) {
            if (!await ensureSession()) {
                throw new Error('Failed to create session');
            }

            return new Promise((resolve, reject) => {
                const wsUrl = ADK_SERVER_URL.replace('http://', 'ws://').replace('https://', 'wss://');
                const wsEndpoint = `${wsUrl}/run_live?app_name=${APP_NAME}&user_id=${USER_ID}&session_id=${SESSION_ID}`;

                console.log(`🔗 Attempting WebSocket connection to: ${wsEndpoint}`);

                try {
                    socket = new WebSocket(wsEndpoint);
                } catch (error) {
                    console.error('❌ Failed to create WebSocket:', error);
                    reject(error);
                    return;
                }

                socket.onopen = () => {
                    console.log('✅ WebSocket connected successfully');

                    const setupMessage = {
                        "app_name": APP_NAME,
                        "user_id": USER_ID,
                        "session_id": SESSION_ID,
                        "run_config": {
                            "streaming_mode": "BIDI",
                            "response_modalities": ["AUDIO"]
                        }
                    };

                    console.log('📤 Sending setup message:', setupMessage);
                    socket.send(JSON.stringify(setupMessage));
                    startAudioRecording(stream);
                    resolve();
                };

                socket.onerror = (error) => {
                    console.error('❌ WebSocket error occurred:', error);
                    reject(error);
                };

                socket.onclose = (event) => {
                    console.log('🔌 WebSocket closed');
                    console.log('📊 Close code:', event.code);
                    console.log('📊 Close reason:', event.reason);

                    if (isStreaming) {
                        stopLiveSession();
                    }
                };

                socket.onmessage = async (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.content && data.content.parts) {
                            const audioPart = data.content.parts.find(p =>
                                p.inlineData &&
                                p.inlineData.mimeType &&
                                p.inlineData.mimeType.startsWith('audio/pcm')
                            );

                            if (audioPart && audioPart.inlineData.data) {
                                let base64String = audioPart.inlineData.data;

                                base64String = base64String.replace(/\s/g, '');
                                base64String = base64String.replace(/-/g, '+').replace(/_/g, '/');

                                while (base64String.length % 4 !== 0) {
                                    base64String += '=';
                                }

                                try {
                                    const binaryString = atob(base64String);
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) {
                                        bytes[i] = binaryString.charCodeAt(i);
                                    }

                                    const pcmData = new Int16Array(bytes.buffer);
                                    audioQueue.push(pcmData);

                                    if (!isPlaying) {
                                        playNextInQueue();
                                    }
                                } catch (e) {
                                    console.error(`❌ Error decoding audio: ${e.message}`);
                                }
                            }
                        }
                    } catch (e) {
                        console.error(`❌ Error processing message: ${e.message}`);
                    }
                };
            });
        }

        function startAudioRecording(stream) {
            try {
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                // Setup audio analyser for visualization
                analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = 256;
                source.connect(analyserNode);

                source.connect(processor);
                processor.connect(audioContext.destination);

                // Start visualization
                setupAudioVisualization();

                processor.onaudioprocess = (e) => {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const pcmData = new Int16Array(inputData.length);

                        for (let i = 0; i < inputData.length; i++) {
                            const s = Math.max(-1, Math.min(1, inputData[i]));
                            pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        }

                        const base64Audio = btoa(String.fromCharCode.apply(null, new Uint8Array(pcmData.buffer)));
                        const audioMessage = {
                            "blob": {
                                "mime_type": "audio/pcm",
                                "data": base64Audio
                            }
                        };

                        socket.send(JSON.stringify(audioMessage));
                    }
                };

                mediaRecorder = { processor, source };

            } catch (error) {
                console.error('❌ Error starting recording:', error);
                throw error;
            }
        }

        async function playNextInQueue() {
            if (audioQueue.length > 0) {
                isPlaying = true;
                const pcmData = audioQueue.shift();

                try {
                    const audioBuffer = audioContext.createBuffer(
                        1,
                        pcmData.length,
                        24000
                    );

                    const channelData = audioBuffer.getChannelData(0);
                    for (let i = 0; i < pcmData.length; i++) {
                        channelData[i] = pcmData[i] / (pcmData[i] < 0 ? 0x8000 : 0x7FFF);
                    }

                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    
                    // Connect to analyser for output visualization
                    if (analyserNode) {
                        source.connect(analyserNode);
                    }
                    
                    source.connect(audioContext.destination);

                    source.onended = () => {
                        playNextInQueue();
                    };

                    source.start(0);
                } catch (error) {
                    console.error(`Error playing audio: ${error.message}`);
                    isPlaying = false;
                    playNextInQueue();
                }
            } else {
                isPlaying = false;
            }
        }

        // Event listeners
        document.getElementById('stopBtn').addEventListener('click', stopLiveSession);
        document.getElementById('videoBtn').addEventListener('click', toggleVideo);
        document.getElementById('screenBtn').addEventListener('click', toggleScreen);

        // Initialize
        window.addEventListener('load', () => {
            loadTheme();
            startLiveSession();
        });
    </script>
</body>

</html>